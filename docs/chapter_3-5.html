<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>XIAO: Big Power, Small Board - 3.5 Telemetry and Commands using the MQTT protocol with XIAO ESP32C3</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter_4.html" rel="next">
<link href="./chapter_3-4.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">XIAO: Big Power, Small Board</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto tools-wide">
    <a href="https://github.com/Mjrovai/XIAO_Big_Power_Small_Board-ebook" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="./XIAO--Big-Power,-Small-Board.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="./XIAO--Big-Power,-Small-Board.epub">
              <i class="bi bi-bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
    </div>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-1" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-1">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter_3.html">Chapter 3: Intermediate Project Practice—Complex Projects</a></li><li class="breadcrumb-item"><a href="./chapter_3-5.html">3.5 Telemetry and Commands using the MQTT protocol with XIAO ESP32C3</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./about_book.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this Book</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./chapter_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 1: Introduction to Hardware and Programming</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1.1 First Arduino program with Seeed Studio XIAO: Blink</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1.2 Using the Button Switch on the XIAO Expansion Board to Control an LED Light</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1.3 Transforming XIAO and its Expansion Board into a Morse Code Transmitter</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1-4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1.4 Monitor Knob Value Changes with Serial Monitor</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1-5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1.5 Controlling LED and Servo with a Knob</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1-6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1.6 Displaying “Hello World” on OLED</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./chapter_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 2: Project Practice for Beginners - Introduction to Prototype Design</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_2-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2.1 Introduction to Product Prototype Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_2-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2.2 Smart Hygrometer and Thermometer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_2-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2.3 Surprise Gift Box Based on Light Sensor</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_2-4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2.4 Rhythmic Dance with a Triaxial Accelerometer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./chapter_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 3: Intermediate Project Practice---Complex Projects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3.1 Smart Remote Control Door</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3.2 Smart Watch</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3.3 Air Piano</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3-4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3.4 Implementing Wi-Fi Connection and Applications with XIAO ESP32C3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3-5.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">3.5 Telemetry and Commands using the MQTT protocol with XIAO ESP32C3</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./chapter_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 4: Project Practice Advanced - TinyML Applications</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4.1 Understanding TinyML and Edge Impulse Studio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4.2 TinyML Made Easy: Anomaly Detection &amp; Motion Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4.3 TinyML Made Easy: Sound Classification (KWS)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4-4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4.4 TinyML Made Easy: Image Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4-5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4.5 TinyML Made Easy: Object Detection</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./chapter_5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 5: Creative Experiments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_5-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5.1 Creative and useful XIAO projects</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./about_authors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About the authors</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background-knowledge" id="toc-background-knowledge" class="nav-link active" data-scroll-target="#background-knowledge">3.5.1 Background Knowledge</a>
  <ul class="collapse">
  <li><a href="#iot-internet-of-things" id="toc-iot-internet-of-things" class="nav-link" data-scroll-target="#iot-internet-of-things">3.5.1.1 IoT (Internet of Things)</a></li>
  <li><a href="#communication-protocols" id="toc-communication-protocols" class="nav-link" data-scroll-target="#communication-protocols">3.5.1.2 Communication Protocols</a></li>
  <li><a href="#message-queuing-telemetry-transport-mqtt" id="toc-message-queuing-telemetry-transport-mqtt" class="nav-link" data-scroll-target="#message-queuing-telemetry-transport-mqtt">3.5.1.3 Message Queuing Telemetry Transport (MQTT) <br></a></li>
  </ul></li>
  <li><a href="#task-1-connect-the-xiao-esp32c3-to-the-mqtt-broker" id="toc-task-1-connect-the-xiao-esp32c3-to-the-mqtt-broker" class="nav-link" data-scroll-target="#task-1-connect-the-xiao-esp32c3-to-the-mqtt-broker">3.5.2 Task 1: Connect the XIAO ESP32C3 to the MQTT Broker</a></li>
  <li><a href="#deep-dive-into-mqtt" id="toc-deep-dive-into-mqtt" class="nav-link" data-scroll-target="#deep-dive-into-mqtt">3.5.3 Deep Dive into MQTT</a></li>
  <li><a href="#telemetry" id="toc-telemetry" class="nav-link" data-scroll-target="#telemetry">3.5.4 Telemetry</a></li>
  <li><a href="#task-2-sending-telemetry-information-from-xiao-to-mqtt-broker" id="toc-task-2-sending-telemetry-information-from-xiao-to-mqtt-broker" class="nav-link" data-scroll-target="#task-2-sending-telemetry-information-from-xiao-to-mqtt-broker">3.5.5 Task 2: Sending Telemetry Information from XIAO to MQTT Broker</a>
  <ul class="collapse">
  <li><a href="#how-often-should-telemetry-be-sent" id="toc-how-often-should-telemetry-be-sent" class="nav-link" data-scroll-target="#how-often-should-telemetry-be-sent">How often should telemetry be sent?</a></li>
  <li><a href="#losing-connection" id="toc-losing-connection" class="nav-link" data-scroll-target="#losing-connection">Losing connection</a></li>
  </ul></li>
  <li><a href="#commands" id="toc-commands" class="nav-link" data-scroll-target="#commands">3.5.6 Commands</a></li>
  <li><a href="#task-3-send-commands-to-xiao-via-mqtt-broker" id="toc-task-3-send-commands-to-xiao-via-mqtt-broker" class="nav-link" data-scroll-target="#task-3-send-commands-to-xiao-via-mqtt-broker">3.5.7 Task 3: Send Commands to XIAO via MQTT Broker</a>
  <ul class="collapse">
  <li><a href="#lost-connection" id="toc-lost-connection" class="nav-link" data-scroll-target="#lost-connection">Lost connection</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Mjrovai/XIAO_Big_Power_Small_Board-ebook/edit/main/chapter_3-5.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/Mjrovai/XIAO_Big_Power_Small_Board-ebook/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/Mjrovai/XIAO_Big_Power_Small_Board-ebook/blob/main/chapter_3-5.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">3.5 Telemetry and Commands using the MQTT protocol with XIAO ESP32C3</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><br> In the previous section, we learned how to send HTTP GET or POST requests from the XIAO ESP32C3 to a local machine on a local area network via Wi-Fi. In this section, we’ll step through: communication protocols, Message Queuing Telemetry Transport (MQTT), telemetry (data gathered from sensors and sent to the cloud), and commands (messages sent from the cloud to a device instructing it to do something).</p>
<section id="background-knowledge" class="level2">
<h2 class="anchored" data-anchor-id="background-knowledge">3.5.1 Background Knowledge</h2>
<section id="iot-internet-of-things" class="level3">
<h3 class="anchored" data-anchor-id="iot-internet-of-things">3.5.1.1 IoT (Internet of Things)</h3>
<p>The “I” in IoT stands for Internet—cloud connectivity and services that enable many of the functions of IoT devices, from gathering sensor measurements linked to devices, to sending messages to control actuators. IoT devices typically connect to a single IoT cloud service using standard communication protocols, and this service is tightly integrated with the rest of your IoT application, from AI services making intelligent decisions around data, to web applications for control or reporting.</p>
<blockquote class="blockquote">
<p>🎓 Data collected from sensors and sent to the cloud is called telemetry.</p>
</blockquote>
<p>IoT devices can also receive information from the cloud. This information typically consists of commands—instructions to perform internal actions (such as rebooting or updating firmware) or to actuate (e.g., turning on a light).</p>
</section>
<section id="communication-protocols" class="level3">
<h3 class="anchored" data-anchor-id="communication-protocols">3.5.1.2 Communication Protocols</h3>
<p>There are many popular communication protocols that IoT devices use to communicate with the internet. The most popular are based around the publishing/subscribing of messages through some agent: IoT devices connect to the agent, publish telemetry data and subscribe to commands. Cloud services also connect to the agent, subscribe to all telemetry information, and publish commands to specific devices or groups of devices, as shown in the figure below.</p>
<!-- ![](https://cdn.nlark.com/yuque/0/2023/jpeg/2392200/1685405887281-5e2cd983-ee0b-4964-8fa0-19a212566c9b.jpeg) -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_1.jpeg" class="img-fluid"></p>
<p>MQTT is the most popular communication protocol for IoT devices and will be covered in this section. Other protocols include AMQP and HTTP/HTTPS, which we introduced in the previous section.</p>
</section>
<section id="message-queuing-telemetry-transport-mqtt" class="level3">
<h3 class="anchored" data-anchor-id="message-queuing-telemetry-transport-mqtt">3.5.1.3 Message Queuing Telemetry Transport (MQTT) <br></h3>
<p><strong>MQTT</strong> is short for Message Queuing Telemetry Transport. It is a messaging protocol based on the publish/subscribe paradigm under the ISO standard: ISO/IEC PRF 20922. It can be seen as a “bridge for data delivery”. It operates on top of the TCP/IP protocol stack and is a publish/subscribe type messaging protocol designed for remote devices with poor hardware performance and poor network conditions. It is a lightweight, open standard messaging transport protocol that can send messages between devices. Originally designed in 1999 for monitoring oil pipelines, it was published as an open standard by IBM 15 years later.</p>
<p>The biggest advantage of MQTT is that it provides a real-time and reliable messaging service for connecting remote devices with minimal code and limited bandwidth. As a low-overhead, low-bandwidth consumption instant communication protocol, it is widely used in IoT, small devices, mobile applications, and so on.</p>
<p>MQTT has one broker and multiple clients. All clients connect to the broker, which then routes messages to the relevant clients. Messages are routed using named topics, not sent directly to a single client. Clients can publish to a topic, and any client subscribed to that topic will receive the message.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2023/png/2392200/1685406029091-18349e9f-5234-4ece-96b8-a54b33c89e51.png#averageHue=%23dedede&clientId=u93bd6905-9e96-4&from=paste&height=147&id=u2452d2f8&originHeight=367&originWidth=1600&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=95157&status=done&style=none&taskId=ufa4c6f8c-dd86-4e79-a0b4-601ec923316&title=&width=640) -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_2.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>✅ Do some research. If you have a large number of IoT devices, how can you ensure that your MQTT broker can handle all messages?</p>
</blockquote>
<section id="some-open-source-mqtt-brokers" class="level4">
<h4 class="anchored" data-anchor-id="some-open-source-mqtt-brokers"><strong>Some Open Source MQTT Brokers</strong></h4>
<p>While we can set up our own MQTT broker if circumstances allow, you might not be ready to delve into server and application setup yet. If you’re just learning, you can start with some open source MQTT brokers.</p>
<section id="eclipse-mosquitto-httpswww.mosquitto.org" class="level5">
<h5 class="anchored" data-anchor-id="eclipse-mosquitto-httpswww.mosquitto.org"><strong>Eclipse Mosquitto</strong> 🔗 <a href="https://www.mosquitto.org/" class="uri">https://www.mosquitto.org/</a></h5>
<p>This is an open source MQTT broker. Instead of dealing with the complexities of setting up an MQTT broker as part of this task, this test broker is publicly available at <a href="https://test.mosquitto.org">test.mosquitto.org</a> and doesn’t require account setup. It’s a great tool for testing MQTT clients and servers.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672296663034-719c868b-07d6-40ef-b93f-a921ab20c39d.png#averageHue=%23e8e8e8&clientId=u11e975e4-de80-4&from=paste&height=1139&id=KctHw&originHeight=2278&originWidth=2822&originalType=binary&ratio=1&rotation=0&showTitle=false&size=691498&status=done&style=stroke&taskId=u7304f2ca-3930-4191-9499-a2fec9b41a4&title=&width=1411)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_3.png" class="img-fluid"></p>
</section>
<section id="shiftr.io" class="level5">
<h5 class="anchored" data-anchor-id="shiftr.io"><a href="https://shiftr.io"><strong>shiftr.io</strong></a></h5>
<p>An IoT platform for interconnected projects, quickly connect hardware and software with its cloud service and desktop applications. The platform also provides a clear view of all connections, topics, and messages in the network through real-time charts. The <a href="https://shiftr.io">shiftr.io</a> broker supports MQTT and HTTP for publishing, subscribing, and retrieving messages, and the platform supports free accounts, enough for us to learn and use. They also provide a public server at <a href="https://public.cloud.shiftr.io">public.cloud.shiftr.io</a> with username <code>public</code> on ports 1883 (MQTT) and 8883 (MQTTS). The animated view of connected services and data being exchanged on the public server is very cool, as shown in the image below.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672297768227-2b393ad4-5ed5-4124-876e-5a6a410821a1.png#averageHue=%2350a95e&clientId=u11e975e4-de80-4&from=paste&height=956&id=BdfcD&originHeight=1912&originWidth=2758&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1221915&status=done&style=none&taskId=udf5fa428-23ff-469b-b100-65fb6a65596&title=&width=1379)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_4.png" class="img-fluid"></p>
</section>
<section id="hivemq" class="level5">
<h5 class="anchored" data-anchor-id="hivemq"><strong>HiveMQ</strong></h5>
<p><a href="https://www.hivemq.com/">HiveMQ</a> is a cloud-based MQTT platform, offering scalable, secure, and reliable IoT communication services. HiveMQ can help enterprises and developers quickly build and manage IoT applications, supporting millions of devices and messages.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672299631681-eea9bdd5-00f6-4060-ae3a-0289fd7c946f.png#averageHue=%23dcdcdb&clientId=u52261d13-9bcb-4&from=paste&height=933&id=gy4Pt&originHeight=1866&originWidth=2958&originalType=binary&ratio=1&rotation=0&showTitle=false&size=656631&status=done&style=none&taskId=u0d5a7565-89ff-43c8-bade-c39f1856c73&title=&width=1479)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_5.png" class="img-fluid"></p>
</section>
</section>
</section>
</section>
<section id="task-1-connect-the-xiao-esp32c3-to-the-mqtt-broker" class="level2">
<h2 class="anchored" data-anchor-id="task-1-connect-the-xiao-esp32c3-to-the-mqtt-broker">3.5.2 Task 1: Connect the XIAO ESP32C3 to the MQTT Broker</h2>
<p>The first step to adding internet control to your smart temperature and humidity meter is to connect the XIAO ESP32C3 to an MQTT broker. <br> In this part of the section, you’ll connect your smart temperature and humidity meter from Section 2.2 to the internet, enabling it to provide telemetry and be remotely controlled. Later in this section, your device will send a telemetry message via MQTT to a public MQTT broker, which will be received by some server code you’ll write. This code will check the temperature and humidity values, and send a command message to the device, telling it to turn a buzzer on or off.</p>
<!-- ![](https://cdn.nlark.com/yuque/0/2023/jpeg/2392200/1685406539410-4eeaa463-2bc1-4a31-bc54-699cd635dc82.jpeg)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_6.jpeg" class="img-fluid"></p>
<p>One real-world use of this setup would be in a large indoor space with many temperature and humidity sensors, such as a farm. Before deciding to turn on air conditioning, data can be gathered from multiple temperature and humidity sensors. If only one sensor reading exceeds the threshold, but other sensor readings are normal, this can prevent the entire air conditioning system from being turned on.</p>
<p>✅ Can you think of other situations where an evaluation of data from multiple sensors is required before issuing a command?</p>
<blockquote class="blockquote">
<p>💁 Remember, this test broker is public and unsecure, and anyone can listen in on what you’re publishing, so it should not be used for any data that needs to be kept confidential.</p>
</blockquote>
<p>Follow the related steps below to connect your device to the MQTT broker we introduced earlier: <a href="https://public.cloud.shiftr.io/">public.cloud.shiftr.io</a>.</p>
<section id="add-the-arduino-mqtt-library" class="level5">
<h5 class="anchored" data-anchor-id="add-the-arduino-mqtt-library"><strong>Add the <a href="https://github.com/256dpi/arduino-mqtt">arduino-mqtt library</a> </strong></h5>
<p>Before you start programming the XIAO ESP32C3 with the Arduino IDE, you need to add the necessary libraries. Type the library URL 🔗 <a href="https://github.com/256dpi/arduino-mqtt" class="uri">https://github.com/256dpi/arduino-mqtt</a> into your browser’s address bar to go to the GitHub page. Click on <code>Code→Download ZIP</code> to download the resource pack <code>arduino-mqtt-master.zip</code> to your local machine, as shown in the image below.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672309298853-fda9fbc3-478f-469d-a27e-4ee45df1c07f.png#averageHue=%23ab997e&clientId=u52261d13-9bcb-4&from=paste&height=933&id=iU4kr&originHeight=1866&originWidth=2528&originalType=binary&ratio=1&rotation=0&showTitle=false&size=581007&status=done&style=stroke&taskId=uc48e4e77-a501-4f68-b00d-5ed87d464f5&title=&width=1264)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_7.png" class="img-fluid"></p>
<p>From the menu bar, select <code>Sketch→Include Library→Add .ZIP Library</code> to add the resource pack <code>arduino-mqtt-master.zip</code> you downloaded in the previous step. Continue until you see a message indicating successful library loading.</p>
</section>
<section id="run-the-esp32-mqtt-example" class="level5">
<h5 class="anchored" data-anchor-id="run-the-esp32-mqtt-example"><strong>Run the ESP32 MQTT example </strong></h5>
<p>After the library is loaded successfully, open the “ESP32DevelopmentBoard” example in the Arduino IDE through the following path: <code>File→Examples→MQTT→ESP32DevelopmentBoard</code>, as shown in the image below.</p>
<!-- ![L15-企业微信20230530-083807\@2x.png](https://cdn.nlark.com/yuque/0/2023/png/2392200/1685407185576-a93d09c8-4b4a-4efe-b97c-ebae8eb485c8.png#averageHue=%23a8b7a1&clientId=u93bd6905-9e96-4&from=ui&id=ud240e8b3&originHeight=2048&originWidth=2512&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=919126&status=done&style=stroke&taskId=ud552462a-e744-43df-ab3b-561e98da415&title=)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_8.png" class="img-fluid"></p>
<p>After the example program is opened, you can see the program as shown below. Then change the <code>ssid</code> in the code to your Wi-Fi network name, and change the <code>pass</code> in the code to the corresponding Wi-Fi password for your Wi-Fi network.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This example uses an ESP32 Development Board</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">// to connect to shiftr.io.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// You can check on your device after a successful</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">// connection here: https://www.shiftr.io/try.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">// by Joël Gähwiler</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">// https://github.com/256dpi/arduino-mqtt</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;WiFi.h&gt;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;MQTT.h&gt;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span> ssid<span class="op">[]</span> <span class="op">=</span> <span class="st">"ssid"</span><span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span> pass<span class="op">[]</span> <span class="op">=</span> <span class="st">"pass"</span><span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>WiFiClient net<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>MQTTClient client<span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> lastMillis <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">connect</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"checking wifi..."</span><span class="op">);</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>WiFi<span class="op">.</span>status<span class="op">()</span> <span class="op">!=</span> WL_CONNECTED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"."</span><span class="op">);</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">connecting..."</span><span class="op">);</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>client<span class="op">.</span><span class="fu">connect</span><span class="op">(</span><span class="st">"arduino"</span><span class="op">,</span> <span class="st">"public"</span><span class="op">,</span> <span class="st">"public"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"."</span><span class="op">);</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"</span><span class="sc">\n</span><span class="st">connected!"</span><span class="op">);</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>subscribe<span class="op">(</span><span class="st">"/hello"</span><span class="op">);</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// client.unsubscribe("/hello");</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> messageReceived<span class="op">(</span>String <span class="op">&amp;</span>topic<span class="op">,</span> String <span class="op">&amp;</span>payload<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"incoming: "</span> <span class="op">+</span> topic <span class="op">+</span> <span class="st">" - "</span> <span class="op">+</span> payload<span class="op">);</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Note: Do not use the client in the callback to publish, subscribe or</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">// unsubscribe as it may cause deadlocks when other things arrive while</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">// sending and receiving acknowledgments. Instead, change a global variable,</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// or push to a queue and handle it in the loop after calling `client.loop()`.</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  WiFi<span class="op">.</span>begin<span class="op">(</span>ssid<span class="op">,</span> pass<span class="op">);</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Note: Local domain names (e.g. "Computer.local" on OSX) are not supported</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">// by Arduino. You need to set the IP address directly.</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>begin<span class="op">(</span><span class="st">"public.cloud.shiftr.io"</span><span class="op">,</span> net<span class="op">);</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>onMessage<span class="op">(</span>messageReceived<span class="op">);</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connect</span><span class="op">();</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>loop<span class="op">();</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span>  <span class="co">// &lt;- fixes some issues with WiFi stability</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>client<span class="op">.</span>connected<span class="op">())</span> <span class="op">{</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">connect</span><span class="op">();</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  <span class="co">// publish a message roughly every second.</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>millis<span class="op">()</span> <span class="op">-</span> lastMillis <span class="op">&gt;</span> <span class="dv">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    lastMillis <span class="op">=</span> millis<span class="op">();</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    client<span class="op">.</span>publish<span class="op">(</span><span class="st">"/hello"</span><span class="op">,</span> <span class="st">"world"</span><span class="op">);</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Get this program from Github <br> <a href="https://github.com/mouseart/XIAO-Mastering-Arduino-and-TinyML/tree/main/code/L15_ESP32DevelopmentBoard_XIAO_en" class="uri">https://github.com/mouseart/XIAO-Mastering-Arduino-and-TinyML/tree/main/code/L15_ESP32DevelopmentBoard_XIAO_en</a></p>
</blockquote>
<p>Run the example and check the serial monitor for: <code>connected!</code>. If you see a connected client and flowing messages in the live chart, your XIAO is continuously sending data to this public MQTT broker!</p>
<!-- ![L15-企业微信20230530-085953\@2x.png](https://cdn.nlark.com/yuque/0/2023/png/2392200/1685408670903-a6344b4b-ccc1-421b-b963-d312ce37e2bc.png#averageHue=%23d28d61&clientId=u5f8b12ef-4f69-4&from=ui&id=u60f8e404&originHeight=1490&originWidth=2304&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=396005&status=done&style=stroke&taskId=u1dd0693d-99ca-445e-a118-5ebc582abcf&title=)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_9.png" class="img-fluid"></p>
<p>You can see the messages you sent by accessing <a href="https://public.cloud.shiftr.io/">public.cloud.shiftr.io</a> in your browser. However, because this is a public broker, your device will quickly get lost in the crowd.</p>
<!-- ![L15-企业微信20230530-090730\@2x.png](https://cdn.nlark.com/yuque/0/2023/png/2392200/1685409058799-2501914c-8e09-499a-bd0a-eccbd38f6ca2.png#averageHue=%2350a95e&clientId=u5f8b12ef-4f69-4&from=ui&id=u4ebf8fb0&originHeight=2158&originWidth=3456&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=1139377&status=done&style=stroke&taskId=u2367aeb5-9b06-4ea7-b13c-7cbc4e027ce&title=)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_10.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>💁 Keep in mind, this test broker is public and insecure. Anyone can listen to what you’re publishing, so it should not be used for anything requiring confidentiality.</p>
</blockquote>
</section>
</section>
<section id="deep-dive-into-mqtt" class="level2">
<h2 class="anchored" data-anchor-id="deep-dive-into-mqtt">3.5.3 Deep Dive into MQTT</h2>
<p>Topics can have a hierarchy, and clients can use wildcards to subscribe to different levels of different hierarchies. For example: you can send temperature telemetry to the <code>/telemetry/temperature</code> topic, humidity data to the <code>/telemetry/humidity</code> topic, and then subscribe to the <code>/telemetry/*</code> topic in your cloud application to receive both temperature and humidity telemetry. When messages are sent, a Quality of Service (QoS) can be specified which determines the guarantee of message delivery.</p>
<ul>
<li>At most once: The message is sent only once, and no additional steps are taken by the client and the broker to confirm delivery (Fire and Forget).</li>
<li>At least once: The message is retried by the sender until it receives an acknowledgment (Acknowledged delivery).</li>
<li>Exactly once: A two-level handshake is performed by the sender and receiver to ensure that only one copy of the message is received (Assured delivery).</li>
</ul>
<blockquote class="blockquote">
<p>✅ In what scenarios might you need to deliver messages on a Fire and Forget basis? <br></p>
</blockquote>
<p>Although MQTT (Message Queuing Telemetry Transport) has “Message Queuing” in its name (the first two letters of MQTT), it does not actually support message queues. This means that if a client disconnects and then reconnects, it will not receive messages that were sent while it was disconnected, except for those messages that it had already begun processing using the QoS process. A retain flag can be set on a message. If this flag is set, the MQTT broker will store the last message sent on a topic with this flag, and will send it to any clients who subsequently subscribe to that topic. This way, clients always receive the latest message. <br> MQTT also supports a keep-alive feature to check if the connection is still online during long intervals between messages.<br> MQTT connections can be public, or encrypted and protected using usernames, passwords, or certificates.</p>
<blockquote class="blockquote">
<p>💁 MQTT communicates over TCP/IP, the same underlying network protocol as HTTP, but on a different port. You can also communicate with web applications running in a browser over MQTT on websockets, or in situations where firewalls or other network rules block standard MQTT connections.</p>
</blockquote>
</section>
<section id="telemetry" class="level2">
<h2 class="anchored" data-anchor-id="telemetry">3.5.4 Telemetry</h2>
<p>The word “telemetry” comes from Greek roots meaning “remote measurement”. Telemetry refers to the act of collecting data from sensors and sending it to the cloud.</p>
<blockquote class="blockquote">
<p>💁 One of the earliest telemetry devices was invented in France in 1874, sending real-time weather and snow depth data from Mont Blanc to Paris. As there was no wireless technology at the time, it used a physical wire.</p>
</blockquote>
<p>Let’s go back to the smart thermostat example from Section 1.1.</p>
<!-- ![Smart Thermostat System Architecture](https://cdn.nlark.com/yuque/0/2022/png/2787433/1646104047138-1f6619a2-42c3-4965-aade-fce5fc3c7404.png#averageHue=%23f4f4f4&clientId=u80ed014f-9032-4&from=ui&id=vWoAE&originHeight=334&originWidth=640&originalType=binary&ratio=1&rotation=0&showTitle=true&size=31278&status=done&style=none&taskId=ud0319ffa-679d-44aa-94e0-4ce3b95d52b&title=Smart%20Thermostat%20System%20Architecture "Smart Thermostat System Architecture")  -->
<div style="text-align:center;">
<img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_11.png" width="400" height="auto" style="margin:0 auto"><br><sub>Smart Thermostat System Architecture</sub>
</div>
<p>The thermostat has temperature sensors to collect telemetry data. It likely has a built-in temperature sensor and may connect to multiple external temperature sensors via wireless protocols such as Low Energy Bluetooth (BLE).</p>
<p>An example of the telemetry data it sends could be:</p>
<table class="table">
<colgroup>
<col style="width: 35%">
<col style="width: 16%">
<col style="width: 48%">
</colgroup>
<thead>
<tr class="header">
<th>Name</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AC_Temperature</td>
<td>18°C</td>
<td>The temperature measured by the thermostat’s built-in temperature sensor</td>
</tr>
<tr class="even">
<td>Living_Room_Temperature</td>
<td>19°C</td>
<td>The temperature measured by a remote temperature sensor named <code>livingroom</code> , indicating the room it is in</td>
</tr>
<tr class="odd">
<td>Bedroom_Temperature</td>
<td>21°C</td>
<td>The temperature measured by a remote temperature sensor named <code>bedroom</code> , indicating the room it is in</td>
</tr>
</tbody>
</table>
<p>Then, the cloud service can use this telemetry data to decide what commands to send to control cooling or heating.</p>
</section>
<section id="task-2-sending-telemetry-information-from-xiao-to-mqtt-broker" class="level2">
<h2 class="anchored" data-anchor-id="task-2-sending-telemetry-information-from-xiao-to-mqtt-broker">3.5.5 Task 2: Sending Telemetry Information from XIAO to MQTT Broker</h2>
<p>The next part of adding internet control to your smart hygrothermograph is sending the temperature and humidity telemetry data to the telemetry topic of the MQTT broker. Replace the XIAO of your smart hygrothermograph device from Section 2.2 with the XIAO ESP32C3, as shown in the image below.</p>
<!-- ![](https://cdn.nlark.com/yuque/0/2023/jpeg/2392200/1677402407719-37a5401e-aa7e-4a0c-87c1-005ad51e82e2.jpeg) -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_12.jpeg" class="img-fluid"></p>
<p>Load the following program into the Arduino IDE to test sending telemetry data from your device to the MQTT broker. Note that in this example, we’re trying a different MQTT broker than in Task 1: <code>broker.hivemq.com</code>, and we’ve set <code>XIAO_ESP32C3_Telemetry/</code> as the subscription name.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">////////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">// IDE:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   Arduino 2.0.0</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Platform:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   esp32 2.0.5 - https://github.com/espressif/arduino-esp32</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Board:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   XIAO_ESP32C3</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Libraries:</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   MQTT 2.5.0 - https://github.com/knolleary/pubsubclient</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   ArduinoJson 6.19.4 - https://github.com/bblanchon/ArduinoJson</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">////////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Includes</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;WiFi.h&gt;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;PubSubClient.h&gt;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"DHT.h"</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DHTTYPE </span>DHT20<span class="pp">   </span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>DHT dht<span class="op">(</span>DHTTYPE<span class="op">);</span> </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> ssid <span class="op">=</span> <span class="st">"ssid"</span><span class="op">;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> password <span class="op">=</span> <span class="st">"pass"</span><span class="op">;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> mqtt_server <span class="op">=</span> <span class="st">"broker.hivemq.com"</span><span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>WiFiClient espClient<span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>PubSubClient client<span class="op">(</span>espClient<span class="op">);</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> lastMsg <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> msg<span class="op">[</span><span class="dv">50</span><span class="op">];</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> temperature <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> humidity <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  setup_wifi<span class="op">();</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>setServer<span class="op">(</span>mqtt_server<span class="op">,</span> <span class="dv">1883</span><span class="op">);</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  Wire<span class="op">.</span>begin<span class="op">();</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  dht<span class="op">.</span>begin<span class="op">();</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup_wifi<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// We start by connecting to a WiFi network</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">();</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Connecting to "</span><span class="op">);</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span>ssid<span class="op">);</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  WiFi<span class="op">.</span>begin<span class="op">(</span>ssid<span class="op">,</span> password<span class="op">);</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>WiFi<span class="op">.</span>status<span class="op">()</span> <span class="op">!=</span> WL_CONNECTED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"."</span><span class="op">);</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">""</span><span class="op">);</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"WiFi connected"</span><span class="op">);</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"IP address: "</span><span class="op">);</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span>WiFi<span class="op">.</span>localIP<span class="op">());</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> reconnect<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Loop until we're reconnected</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>client<span class="op">.</span>connected<span class="op">())</span> <span class="op">{</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Attempting MQTT connection..."</span><span class="op">);</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attempt to connect</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>client<span class="op">.</span><span class="fu">connect</span><span class="op">(</span><span class="st">"XIAO_ESP32"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"connected"</span><span class="op">);</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Subscribe</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>      client<span class="op">.</span>subscribe<span class="op">(</span><span class="st">"XIAO_ESP32/LEDOUTPUT"</span><span class="op">);</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"failed, rc="</span><span class="op">);</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span>client<span class="op">.</span>state<span class="op">());</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">" try again in 5 seconds"</span><span class="op">);</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Wait 5 seconds before retrying</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>      delay<span class="op">(</span><span class="dv">5000</span><span class="op">);</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>client<span class="op">.</span>connected<span class="op">())</span> <span class="op">{</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    reconnect<span class="op">();</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>loop<span class="op">();</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>  <span class="dt">long</span> now <span class="op">=</span> millis<span class="op">();</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>  <span class="dt">float</span> temp_hum_val<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>now <span class="op">-</span> lastMsg <span class="op">&gt;</span> <span class="dv">5000</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    lastMsg <span class="op">=</span> now<span class="op">;</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    dht<span class="op">.</span>readTempAndHumidity<span class="op">(</span>temp_hum_val<span class="op">);</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    temperature <span class="op">=</span> temp_hum_val<span class="op">[</span><span class="dv">1</span><span class="op">];</span>   </span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> tempString<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    dtostrf<span class="op">(</span>temperature<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> tempString<span class="op">);</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Temperature: "</span><span class="op">);</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span>tempString<span class="op">);</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>    client<span class="op">.</span>publish<span class="op">(</span><span class="st">"XIAO_ESP32C3_Telemetry/Temperaturedataread"</span><span class="op">,</span> tempString<span class="op">);</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    humidity <span class="op">=</span> temp_hum_val<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> humString<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    dtostrf<span class="op">(</span>humidity<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> humString<span class="op">);</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Humidity: "</span><span class="op">);</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>println<span class="op">(</span>humString<span class="op">);</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    client<span class="op">.</span>publish<span class="op">(</span><span class="st">"XIAO_ESP32_Telemetry/Humiditydataread"</span><span class="op">,</span> humString<span class="op">);</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Get this program from Github <br> <a href="https://github.com/mouseart/XIAO-Mastering-Arduino-and-TinyML/tree/main/code/L15_MQTTTelemetry_XIAO_en" class="uri">https://github.com/mouseart/XIAO-Mastering-Arduino-and-TinyML/tree/main/code/L15_MQTTTelemetry_XIAO_en</a></p>
</blockquote>
<p>Because this example relies on the <code>PubSubClient.h</code> library, if you try to compile it directly, you will encounter the error “<strong>PubSubClient.h: No such file or directory</strong>”. To resolve this issue, follow the steps below to install the library.</p>
<ol type="1">
<li>Open the Arduino IDE.</li>
<li>Go to “Sketch” -&gt; “Include Library” -&gt; “Manage Libraries”.</li>
<li>In the Library Manager, type “PubSubClient” in the search bar.</li>
<li>Look for the “PubSubClient” library by Nick O’Leary and click on it.</li>
<li>Click the “Install” button to install the library.</li>
</ol>
<p>Then modify the <code>ssid</code> in the code to your Wi-Fi network name and <code>pass</code> to your Wi-Fi password corresponding to your Wi-Fi network name. <br> After successfully uploading the program, open the serial monitor. If all goes well, you will see the device start sending temperature and humidity data, as shown in the image below.</p>
<!-- ![L15-企业微信20230530-112625\@2x.png](https://cdn.nlark.com/yuque/0/2023/png/2392200/1685417355488-b027a157-0ee4-4c82-ba6d-4d9f978b1036.png#averageHue=%23dd8f60&clientId=u5fccfc03-db3e-4&from=ui&id=u4f02e101&originHeight=1490&originWidth=2792&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=401970&status=done&style=stroke&taskId=u52a93cca-2497-4cfb-9a77-8ff794d358c&title=) -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_13.png" class="img-fluid"></p>
<p>How can you see the sensor data from another platform? There are many ways, such as <a href="https://mqttx.app/">MQTT X</a>. After downloading and installing the software suitable for your PC system, the interface is as shown in the image below.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672371305711-93cbeda7-b1c2-49c0-9314-f6a73f26b959.png#averageHue=%23798c8b&clientId=uebdc8a20-1ffe-4&from=paste&height=800&id=QuSNg&originHeight=1600&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=380552&status=done&style=stroke&taskId=u85374eb5-a21b-409a-90d5-5ee36e20530&title=&width=1280) -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_14.png" class="img-fluid"></p>
<p>Clicking the <code>+ New Connection</code> button will bring you to the connection creation window, as shown in the image below. Fill in <code>XIAO-DHT20</code> in the Name box as the connection name. The Host is <code>broker.hivemq.com</code> that we set in the program, no other settings are needed, click <code>Connect</code> in the upper right corner.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672371484572-26df05b7-34e5-4b52-b735-531d26fcc3b2.png#averageHue=%23e3b34d&clientId=uebdc8a20-1ffe-4&from=paste&height=800&id=kRuig&originHeight=1600&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=369940&status=done&style=stroke&taskId=u89ceb3c2-8375-4f62-ae88-5b191a3607d&title=&width=1280) -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_15.png" class="img-fluid"></p>
<p>Create a new subscription, showing all the information under <code>XIAO_ESP32C3_Telemetry/</code>, as shown in the image below.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672380401266-438f29b0-e7ef-4032-aeee-92d975550d8d.png#averageHue=%2380807e&clientId=uebdc8a20-1ffe-4&from=paste&height=650&id=sYAEV&originHeight=1300&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=282606&status=done&style=stroke&taskId=u201ad92f-2a4a-4cbe-82b2-495238a8647&title=&width=1280) -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_16.png" class="img-fluid"></p>
<p>Now, we can see the telemetry data sent from XIAO ESP32C3, as shown in the image below.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672380324197-f6cbf58a-f0f7-4feb-8930-cacd685fbf05.png#averageHue=%23fefefd&clientId=uebdc8a20-1ffe-4&from=paste&height=650&id=wvL6N&originHeight=1300&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=342487&status=done&style=stroke&taskId=ud4c14b99-26ae-4063-8aad-a19af73b6d3&title=&width=1280)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_17.png" class="img-fluid"></p>
<section id="how-often-should-telemetry-be-sent" class="level3">
<h3 class="anchored" data-anchor-id="how-often-should-telemetry-be-sent">How often should telemetry be sent?</h3>
<p>One question that needs careful consideration with telemetry is: how often should you measure and send data? The answer is — it depends on the needs of the device being monitored and the task at hand. If you measure frequently, you can indeed respond to changes in the measurements more quickly, but this would cause your device to consume more power, more bandwidth, generate more data, and require more cloud resources to handle. You need to strike a balance between measuring often enough but not too often.</p>
<p>For a thermostat, measuring every few minutes might be enough because the temperature isn’t likely to change frequently. If you only measure once a day, then you might be heating your house for nighttime temperatures on a sunny day, and if you measure every second, you’d have thousands of unnecessary repeated temperature measurements which will eat up users’ internet speed and bandwidth (which is a problem for people with limited bandwidth plans), and also consume more power, which is a problem for devices like remote sensors that rely on battery power, and further increase the cost of cloud computing resources to process and store them.</p>
<p>If you’re monitoring data around a machine in a factory that might cause catastrophic damage and millions in lost revenue if it fails, then measuring multiple times a second may be necessary. Wasting bandwidth is better than missing telemetry data that could signal the need to stop and repair before a machine fails.</p>
<blockquote class="blockquote">
<p>💁 In this situation, you could consider first using an edge device to handle the telemetry data to reduce dependence on the internet.</p>
</blockquote>
</section>
<section id="losing-connection" class="level3">
<h3 class="anchored" data-anchor-id="losing-connection">Losing connection</h3>
<p>Internet connections can be unreliable, and it’s common to lose signal. In this case, what should an IoT device do? Should it lose data, or should it store data until the connection is restored? Again, the answer is — it depends on the device being monitored.</p>
<p>For a thermostat, data is likely lost once a new temperature measurement has been made. If the current temperature is 19°C, the heating system doesn’t care that the temperature 20 minutes ago was 20.5°C; it’s the current temperature that dictates whether the heat should be turned on or off.</p>
<p>For some machines, you may want to retain this data, especially if it’s being used to look for trends. Some machine learning models can identify anomalies in data streams by looking at a defined time period (e.g., the last hour). This is often used for predictive maintenance, looking for signs that something might be about to fail so you can repair or replace it before disaster strikes. You may want every point of telemetry from a machine sent so it can be used for anomaly detection, so once an IoT device can reconnect, it will send all the telemetry data generated during the internet outage.</p>
<p>IoT device designers should also consider whether an IoT device can operate during an internet outage or if it loses signal due to location. If a smart thermostat is unable to send telemetry data to the cloud due to an internet outage, it should be able to make some limited decisions to control heating.</p>
<!-- > ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1651566081348-bf19f1fe-a068-4523-9f69-cd85215977fd.png#averageHue=%2390938e&clientId=u52c988bc-8533-4&from=paste&height=861&id=umgQ5&originHeight=1722&originWidth=1080&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3142169&status=done&style=none&taskId=u189a65bd-34a0-47b8-9fe0-c313e189ed3&title=&width=540) <br /> -->
<blockquote class="blockquote">
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_18.png" class="img-fluid"> <br> This Ferrari became a brick when someone tried to update it in an underground car park… but there was no cell signal there.</p>
</blockquote>
<p>For MQTT handling connection interruptions, if necessary, the device and server code will need to be responsible for ensuring message delivery, for example, requiring all sent messages to be replied to by an additional message on the reply topic, and if not, to manually queue them for later resending.</p>
</section>
</section>
<section id="commands" class="level2">
<h2 class="anchored" data-anchor-id="commands">3.5.6 Commands</h2>
<p>Commands are messages sent by the cloud to a device instructing it to do something. Most often, this involves providing some output via an actuator, but it could be an instruction to the device itself, such as to reboot, or to collect additional telemetry data and send it as a response to the command.</p>
<!-- ![commands.png](https://cdn.nlark.com/yuque/0/2022/png/2787433/1646113961729-48acb652-3ee9-4b08-b101-0fb1dcec0cda.png#averageHue=%23f5f5f5&clientId=ua938bc53-e5a4-4&from=ui&id=i9mV2&originHeight=334&originWidth=640&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31685&status=done&style=none&taskId=uecd0aa71-7b07-4187-ac57-0be39a688cf&title=)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_19.png" class="img-fluid"> <br></p>
<p>A thermostat could receive a command from the cloud to turn on the heat. Based on the telemetry data from all sensors, if the cloud service has decided that the heat should be turned on, then it sends the appropriate command.</p>
</section>
<section id="task-3-send-commands-to-xiao-via-mqtt-broker" class="level2">
<h2 class="anchored" data-anchor-id="task-3-send-commands-to-xiao-via-mqtt-broker">3.5.7 Task 3: Send Commands to XIAO via MQTT Broker</h2>
<p>Having mastered telemetry, the next step is to send commands to IoT devices via an MQTT broker. In this task, we will try to use a computer with MQTT broker, often called a host computer, to send specific characters and let the Wi-Fi connected XIAO ESP32C3 control a buzzer attached to an expansion board to emit a warning sound.</p>
<p>In the Arduino IDE, load the following program to test sending specific characters (first character is ‘0’) from the MQTT broker to activate the buzzer. We use the MQTT broker: <code>broker.hivemq.com</code> in this example.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">////////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">// IDE:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   Arduino 2.0.0</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Platform:</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   esp32 2.0.5 - https://github.com/espressif/arduino-esp32</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Board:</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   XIAO_ESP32C3</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Libraries:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   MQTT 2.5.0 - https://github.com/knolleary/pubsubclient</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   ArduinoJson 6.19.4 - https://github.com/bblanchon/ArduinoJson</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">//  https://github.com/Seeed-Studio/Seeed_Arduino_MultiGas</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">////////////////////////////////////////////////////////////////////////////////</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Includes</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;WiFi.h&gt;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;PubSubClient.h&gt;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> ssid <span class="op">=</span> <span class="st">"ssid"</span><span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> password <span class="op">=</span> <span class="st">"pass"</span><span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> mqtt_server <span class="op">=</span> <span class="st">"broker.hivemq.com"</span><span class="op">;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>WiFiClient espClient<span class="op">;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>PubSubClient client<span class="op">(</span>espClient<span class="op">);</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> lastMsg <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> msg<span class="op">[</span><span class="dv">50</span><span class="op">];</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> speakerPin <span class="op">=</span> A3<span class="op">;</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup_wifi<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">// We start by connecting to a WiFi network</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">();</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Connecting to "</span><span class="op">);</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span>ssid<span class="op">);</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  WiFi<span class="op">.</span>begin<span class="op">(</span>ssid<span class="op">,</span> password<span class="op">);</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>WiFi<span class="op">.</span>status<span class="op">()</span> <span class="op">!=</span> WL_CONNECTED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"."</span><span class="op">);</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">""</span><span class="op">);</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"WiFi connected"</span><span class="op">);</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"IP address: "</span><span class="op">);</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">(</span>WiFi<span class="op">.</span>localIP<span class="op">());</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> callback<span class="op">(</span><span class="dt">char</span><span class="op">*</span> topic<span class="op">,</span> byte<span class="op">*</span> payload<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Message arrived ["</span><span class="op">);</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span>topic<span class="op">);</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"] "</span><span class="op">);</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>length<span class="op">;</span>i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">((</span><span class="dt">char</span><span class="op">)</span>payload<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">((</span><span class="dt">char</span><span class="op">)</span>payload<span class="op">[</span><span class="dv">0</span><span class="op">]==</span><span class="ch">'0'</span><span class="op">){</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"  RUN"</span><span class="op">);</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>speakerPin<span class="op">,</span> HIGH<span class="op">);</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">2000</span><span class="op">);</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>speakerPin<span class="op">,</span> LOW<span class="op">);</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">100</span><span class="op">);</span>  </span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">();</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>  pinMode<span class="op">(</span>speakerPin<span class="op">,</span> OUTPUT<span class="op">);</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>  setup_wifi<span class="op">();</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>setServer<span class="op">(</span>mqtt_server<span class="op">,</span> <span class="dv">1883</span><span class="op">);</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>subscribe<span class="op">(</span><span class="st">"XIAO_ESP32/Recieve"</span><span class="op">);</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>setCallback<span class="op">(</span>callback<span class="op">);</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> reconnect<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Loop until we're reconnected</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>client<span class="op">.</span>connected<span class="op">())</span> <span class="op">{</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Attempting MQTT connection..."</span><span class="op">);</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attempt to connect</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>client<span class="op">.</span><span class="fu">connect</span><span class="op">(</span><span class="st">"XIAO_ESP32"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">"connected"</span><span class="op">);</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Subscribe</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"failed, rc="</span><span class="op">);</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>print<span class="op">(</span>client<span class="op">.</span>state<span class="op">());</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">" try again in 5 seconds"</span><span class="op">);</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Wait 5 seconds before retrying</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>      delay<span class="op">(</span><span class="dv">5000</span><span class="op">);</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>client<span class="op">.</span>connected<span class="op">())</span> <span class="op">{</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    reconnect<span class="op">();</span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    client<span class="op">.</span>subscribe<span class="op">(</span><span class="st">"XIAO_ESP32/Recieve"</span><span class="op">);</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span>loop<span class="op">();</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Get this program from Github <br> <a href="https://github.com/mouseart/XIAO-Mastering-Arduino-and-TinyML/tree/main/code/L15_MQTTCommand_XIAO_en" class="uri">https://github.com/mouseart/XIAO-Mastering-Arduino-and-TinyML/tree/main/code/L15_MQTTCommand_XIAO_en</a></p>
</blockquote>
<p>Then modify the <code>ssid</code> in the code to your Wi-Fi network name, and modify the <code>pass</code> in the code to the Wi-Fi password corresponding to your Wi-Fi network name. <br> The logic of the program execution is explained as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span>setServer<span class="op">(</span>mqtt_server<span class="op">,</span> <span class="dv">1883</span><span class="op">);</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span>subscribe<span class="op">(</span><span class="st">"XIAO_ESP32/Recieve"</span><span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span>setCallback<span class="op">(</span>callback<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>During the <code>setup</code> stage, the connection between XIAO and the MQTT server is initialized, and the topic subscription settings and callback functions are set. Here we subscribe to the topic <code>XIAO_ESP32/Recieve</code> as an example. When we send a message to this topic from the host computer, the corresponding callback function <code>callback</code> will be executed:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> callback<span class="op">(</span><span class="dt">char</span><span class="op">*</span> topic<span class="op">,</span> byte<span class="op">*</span> payload<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"Message arrived ["</span><span class="op">);</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span>topic<span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"] "</span><span class="op">);</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>length<span class="op">;</span>i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">((</span><span class="dt">char</span><span class="op">)</span>payload<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">((</span><span class="dt">char</span><span class="op">)</span>payload<span class="op">[</span><span class="dv">0</span><span class="op">]==</span><span class="ch">'0'</span><span class="op">){</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    Serial<span class="op">.</span>print<span class="op">(</span><span class="st">"  RUN"</span><span class="op">);</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>speakerPin<span class="op">,</span> HIGH<span class="op">);</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">2000</span><span class="op">);</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    digitalWrite<span class="op">(</span>speakerPin<span class="op">,</span> LOW<span class="op">);</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    delay<span class="op">(</span><span class="dv">100</span><span class="op">);</span>  </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  Serial<span class="op">.</span>println<span class="op">();</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here it will first print out the received message, then extract the character at position <code>0</code>. When the character at position <code>0</code>, which is the first character, is<code>0</code>, it satisfies the condition for the <code>if</code> statement to perform an action. Here we connect the XIAO ESP32C3 and the expansion board together. When the condition is met, the buzzer on the expansion board will change its level briefly and beep for 2 seconds, while sending the prompt message<code>RUN</code> to the serial port.</p>
<p>In the process of development and testing by readers, you can also try to integrate the receive and send functions of MQTT, and send messages to specific topics in the callback function, so that the sender can ensure that XIAO has received the message.</p>
<p>On the host computer, we use <a href="https://mqttx.app/">MQTT X</a> to test. Open MQTT X, the interface is as shown in the following figure.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/2392200/1672371305711-93cbeda7-b1c2-49c0-9314-f6a73f26b959.png#averageHue=%23798c8b&clientId=uebdc8a20-1ffe-4&from=paste&height=800&id=M8muz&originHeight=1600&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=380552&status=done&style=stroke&taskId=u85374eb5-a21b-409a-90d5-5ee36e20530&title=&width=1280)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_20.png" class="img-fluid"></p>
<p>Click the <code>+ New Connection</code> button to enter the connection creation window, as shown in the following figure. Fill in the Name box with <code>XIAO-MQTT-Recieve</code> as the connection name. Host is the <code>broker.hivemq.com</code> we set in the program, and nothing else needs to be set. Click <code>Connect</code> at the top right corner. The interface after successful connection is as shown in the following figure.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2023/png/2392200/1673920699143-0fcdafd5-11ba-4e4c-af07-3c660ff2061e.png#averageHue=%2392d2ad&clientId=u00a9c4a9-6772-4&from=paste&height=800&id=uYxZC&originHeight=1600&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=320824&status=done&style=stroke&taskId=uf03388f0-d5c9-48ea-876b-9a79cdf8628&title=&width=1280)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_21.png" class="img-fluid"></p>
<p>Now we can publish messages to the specified topic, which is the topic <code>XIAO_ESP32/Recieve</code> we subscribed to on XIAO. Then we enter <code>00</code> in the input box of <code>XIAO_ESP32/Recieve</code> at the lower right corner of the interface, and then click the send button <img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_22.png" alt="send-button.png" width="30" height="30"> in the lower right corner.</p>
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2023/png/2392200/1673922637488-6615c8cf-7f3d-409f-bd2a-96f99e6f5ca2.png#averageHue=%23fefefd&clientId=u00a9c4a9-6772-4&from=paste&height=800&id=SALZf&originHeight=1600&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=379697&status=done&style=stroke&taskId=ub7e7a922-e73e-4fa8-ad07-e160c523179&title=&width=1280)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_23.png" class="img-fluid"></p>
<p>At this time, in the serial monitor on the PC side, you can see the prompt message received from XIAO, as shown in the following figure, and prompt <code>RUN</code>, the buzzer will sound for 2 seconds, indicating that the message has been received.</p>
<!-- ![L15-企业微信20230530-163118\@2x.png](https://cdn.nlark.com/yuque/0/2023/png/2392200/1685435499239-7a3abaf1-aa62-4484-8ff7-1074fd0f487d.png#averageHue=%23d38c61&clientId=u8b044297-98e8-4&from=ui&id=u6ebfb210&originHeight=1490&originWidth=2304&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=355861&status=done&style=stroke&taskId=u3a91a7a8-65d4-4ab7-bb94-9be485e4ded&title=)  -->
<p><img src="https://files.seeedstudio.com/wiki/XIAO_Big_Power-Board-ebook-photo/chapter_3-5/chapter_3-5_24.png" class="img-fluid"></p>
<p>Now, we have successfully driven the buzzer on the expansion board connected to the Wi-Fi connected XIAO ESP32C3 through the instruction sent by the PC side. <br> The action of the buzzer can be replaced with the control of any peripheral to achieve the desired function.</p>
<section id="lost-connection" class="level3">
<h3 class="anchored" data-anchor-id="lost-connection">Lost connection</h3>
<p>If a cloud service needs to send a command to an offline IoT device, what should it do? Again, the answer depends on the situation. If the latest command overwrites the previous one, the previous command may be ignored. If the cloud service sends a command to turn on the heating, and then sends another command to turn off the heating, then the turn-on command can be ignored and does not need to be resent. <br> If the commands need to be processed in order, such as first moving the robot arm up and then closing the gripper, then they need to be sent in order once the connection is restored.</p>
<blockquote class="blockquote">
<p>✅ How can device or server code ensure that commands are always sent and processed in order through MQTT if needed?</p>
</blockquote>
<blockquote class="blockquote">
<h3 id="using-xiaos-bluetooth-function" class="anchored">Using XIAO’s Bluetooth function</h3>
<p>XIAO nRF52840, XIAO nRF52840 Sense, XIAO ESP32C3 all support Bluetooth function, you can refer to the related Wiki documents to learn how to use the Bluetooth function.</p>
<ul>
<li><a href="https://wiki.seeedstudio.com/XIAO_ESP32C3_Bluetooth_Usage/">Bluetooth Usage on Seeed Studio XIAO ESP32C3</a></li>
<li><a href="https://wiki.seeedstudio.com/XIAO-BLE-Sense-Bluetooth_Usage/">Bluetooth Usage (Seeed nRF52 Boards Library)</a></li>
<li><a href="https://wiki.seeedstudio.com/XIAO-BLE-Sense-Bluetooth-Usage/">Bluetooth Usage (Seeed nrf52 mbed-enabled Boards Library)</a></li>
</ul>
</blockquote>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter_3-4.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">3.4 Implementing Wi-Fi Connection and Applications with XIAO ESP32C3</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter_4.html" class="pagination-link">
        <span class="nav-page-text">Chapter 4: Project Practice Advanced - TinyML Applications</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">XIAO: Big Power, Small Board</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>



</body></html>